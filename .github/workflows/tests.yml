name: Tests & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: affiliate_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: pdo, pdo_mysql, redis, json, curl
        tools: composer, phpunit

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Create .env file
      run: |
        cp .env.example .env
        sed -i 's/DB_HOST=localhost/DB_HOST=127.0.0.1/g' .env
        sed -i 's/REDIS_HOST=localhost/REDIS_HOST=127.0.0.1/g' .env

    - name: Setup database
      run: |
        mysql -h 127.0.0.1 -u root -proot affiliate_test < database/schema.sql

    - name: Run PHPUnit tests
      run: ./vendor/bin/phpunit tests/ --coverage-text --coverage-clover=coverage.xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        fail_ci_if_error: false

    - name: Run PHP Code Sniffer
      run: ./vendor/bin/phpcs src/ --standard=PSR12 --report=summary || true

    - name: Run PHPStan
      run: ./vendor/bin/phpstan analyse src/ --level=8 || true

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: secrets.DOCKER_USERNAME != ''

    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: affiliate-platform:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker build
      run: docker build -t affiliate-platform:test .

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Run security check
      uses: puskin94/github-action-php-security-check@main

    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'Affiliate Platform'
        path: '.'
        format: 'JSON'
      continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'

    - name: Run PHPMD
      run: |
        composer global require phpmd/phpmd
        /home/runner/.composer/vendor/bin/phpmd src/ text cleancode || true

    - name: Check file permissions
      run: |
        find . -type f -name "*.php" -exec php -l {} \; > /dev/null 2>&1 && echo "✓ PHP syntax check passed" || exit 1

    - name: Check for security issues in code
      run: |
        grep -r "eval(" src/ . && exit 1 || echo "✓ No eval() found"
        grep -r "system(" src/ . && exit 1 || echo "✓ No system() found"
        true
